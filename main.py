import logging, re, random, asyncio, os
from aiogram import Bot, Dispatcher, types, Router
from aiohttp import web

API_TOKEN = os.getenv('BOT_TOKEN')

logging.basicConfig(level=logging.ERROR)
bot = Bot(token=API_TOKEN)
router = Router()

KEYWORDS = {
    'mind': ['ум', 'интеллект', 'внимательность', 'знания', 'мудрость', 'расследование', 'вспомнить', 'понять', 'догадаться', 'запомнить'],
    'magic': ['магия', 'магический', 'заклинание', 'колдовать', 'аркана', 'чары', 'волшебство', 'энергия', 'потоки'],
    'attack': ['атака'],
    'dex': ['спас ловкости', 'ловкость', 'реакция', 'уклонение', 'акробатика', 'грация', 'спрыгнуть', 'увернуться'],
    'str': ['спас силы', 'сила', 'мощь', 'живучесть', 'выдержать', 'устоять', 'мышцы', 'мощный'],
    'cha': ['харизма', 'обаяние', 'убеждение', 'запугивание', 'обман', 'выступление', 'лидерство', 'флирт', 'очарование', 'разговор', 'уговорить', 'соврать'],
    'summon': ['призыв', 'призвать', 'вызвать', 'summon', 'призываю'],
    'gamble': ['везение', 'казино', 'ставка', 'монетка', 'фортуна', 'удача в игре', 'азарт', 'сыграть', 'выигрыш', 'проигрыш']
}

PHRASES = {
    'crit_success': {
        'mind': ["Твой мозг только что сделал шах и мат самому себе. В хорошем смысле.", "Ты вспомнил даже то, чего не знал. Видимо, боги подсказали.", "Гениально! Тебе аплодируют мысленно все философы мира.", "Ты не просто понял — ты теперь это можешь преподавать. Боги в первом ряду.", "Решение пришло само. С небес. С подписью \"Одобрено высшими силами\"."],
        'magic': ["Твоё заклинание спело. Красиво. В правильной тональности.", "Магия облизала тебя с ног до головы. В хорошем смысле.", "Энергия легла ровно, как шёлк на плечи императора.", "Ты колданул так, что даже боги захотели автограф.", "Потоки магии выстроились в почётный караул. Боги аплодируют стоя."],
        'attack': ["Твой удар попал прямо в душу. Буквально.", "Противник только что понял, что зря встал сегодня с кровати.", "Ты вложил в это всю злость. И немного любви. Получилось ядерно.", "Удар такой силы, что враг перепутал день с ночью. И упал.", "Ты попал так, что боги зааплодировали. Громогласно."],
        'dex': ["Ты увернулся так, что гравитация пожала плечами и ушла.", "Твоё тело сделало кульбит, достойный цирка. Без страховки.", "Ты просто исчез из точки удара. И появился там, где безопасно.", "Реакция уровня \"я знал, что так будет, ещё до того, как это случилось\".", "Ты двигаешься так плавно, что законы физики берут у тебя автограф."],
        'str': ["Ты выдержал. Даже не вспотел. Хотя должен был.", "Твои мышцы спели песню победы. Без слов. Но мощно.", "Ты просто сказал: \"Не сегодня\". И опасность отступила.", "Сила богатырская. Можно таверны сворачивать в трубочку.", "Ты устоял там, где падали титаны. Скромно так. Без понтов."],
        'cha': ["Ты открыл рот — и у всех внутри заиграла музыка.", "Твоя улыбка растопила лёд. Даже в сердцах богов.", "Ты сказал всего пару слов. Этого хватило, чтобы войти в легенды.", "Собеседник готов продать душу. Пока ты говоришь. Боги в очереди.", "Ты врёшь так сладко, что ложь пахнет пирожками. Даже боги поверили."],
        'summon': ["Ты позвал — и оно пришло. С поклоном. И цветами.", "Призыв удался так, что вызванное существо попросило автограф.", "Твой призыв явился с опозданием. Потому что собирало подарки. Для тебя.", "Существо не просто пришло — оно притащило друга. Бесплатно.", "Ты призвал легенду. Теперь она у тебя в должниках."],
        'gamble': ["Фортуна сегодня на твоей стороне. Боги завидуют.", "Тебе сегодня нельзя проиграть. Даже если очень хочешь. Боги на стороне.", "Удача оседлала тебя и скачет в закат. Держись крепче.", "Монетка падает ребром. Всегда. Только для тебя.", "Ты мог бы сейчас играть на деньги богов. И выигрывать."],
        'default': ["Тебе сегодня звезды шепчут: \"Ты красавчик, делай что хочешь\".", "Удача пришла. Села рядом. Налила чаю.", "Сегодня твой день. Даже сломанное работает.", "Фарт прет так, что аж свистит в ушах.", "Ты просто везунчик по жизни. Остальным можно завидовать молча."]
    },
    'crit_fail': {
        'mind': ["Твой мозг объявил забастовку. Без предупреждения. Боги в курсе, им смешно.", "Ты вспомнил, как звали твою первую черепашку. Вместо пароля от сейфа.", "В голове ветер. Сквозняк. И эхо собственных ошибок.", "Мысль была. Ушла в запой. Обещала вернуться. Не вернулась.", "Ты так глубоко задумался, что забыл, о чём думал. Боги ржут."],
        'magic': ["Твоё заклинание вышло кривым, косым и обоссанным.", "Магия плюнула тебе в душу. И ушла к другому.", "Ты хотел файрбол. Получился \"пшик\". Обидный. Боги в голос.", "Энергия просто не пришла. У неё были дела поважнее.", "Ты попытался колдовать, но получился пердёж в лужу. Громкий."],
        'attack': ["Ты махнул. Воздух испугался. Враг чихнул. Вот и весь урон.", "Твой удар увидели потомки. Они до сих пор смеются. Боги тоже.", "Ты промахнулся так эпично, что попал в своего. Морально.", "Противник даже не понял, что это атака. Думал, ты танцуешь.", "Ты старался. Честно. Просто удара не получилось. Бывает."],
        'dex': ["Ты споткнулся о воздух. Потом упал. Потом лежал и думал о жизни.", "Твоя реакция ушла в отпуск. Навсегда.", "Ты попытался увернуться, но ноги выбрали разные направления.", "Гравитация сегодня работает против тебя. Как профсоюз.", "Ты упал. Сам. Без помощи. Гордиться нечем."],
        'str': ["Твои мышцы написали заявление: \"Устали, увольняемся\".", "Ты попытался быть сильным. Получилось жалким.", "Силы покинули тебя. Как крысы тонущий корабль.", "Ты сложился пополам. Потом ещё раз. Потом сдался.", "Ты выдержал ровно ноль секунд. Это антирекорд."],
        'cha': ["Ты открыл рот — и все захотели его закрыть. Навсегда. Даже боги поморщились.", "Ты попыталсяшутить. Тишина была такой громкой, что оглохло эхо.", "Твоя улыбка испугала детей. Стариков. И пару демонов.", "Ты хотел быть милым. Получилось криповым.", "Ты соврал. Даже собака поняла. И ушла. Гордо. Боги в лёгком шоке."],
        'summon': ["Ты позвал. Никто не пришёл. Даже эхо постеснялось.", "Призыв удался. Но пришло не то. Совсем не то. Оно злое.", "Ты призвал существо. Оно посмотрело, вздохнуло и ушло обратно.", "Призыв сработал. Теперь у тебя демон под кроватью. Навечно.", "Ты крикнул в пустоту. Пустота крикнула в ответ: \"Сам такой\"."],
        'gamble': ["Тебе нельзя играть даже в \"камень-ножницы-бумага\". Проиграешь вселенной.", "Удача плюнула тебе в тарелку. И ушла к другому игроку.", "Ты мог бы проиграть даже в игре, где всего один игрок. Ты.", "Фортуна сегодня в отпуске. Без тебя. С твоими деньгами.", "Монетка упала ребром. В трещину. В ад. Без возврата."],
        'default': ["Тебе сегодня не везёт. Даже в мелочах. Даже там, где везёт всем.", "Удача посмотрела на тебя и перешла на другую сторону улицы.", "Ты родился под несчастливой звездой. Сегодня она взорвалась.", "Фарт ушел в минус. Теперь ты должен удаче.", "Сегодня твой день. Но не твой. А чей-то чужой. Плохой."]
    },
    'high': {
        'mind': ["Голова варит. Не как котел, но как приличная кастрюля.", "Ты почти гениален. Самую малость не хватило.", "Мысль пришла. Вежливая. Хорошая мысль.", "Ты вспомнил главное. Мелочи подождут."],
        'magic': ["Магия слушается. Немного капризничает, но терпит.", "Вышло мощно. Без фейерверков, но с искрами.", "Ты колданул крепко. Профессионально. Без дураков.", "Заклинание легло как надо. Ровно."],
        'attack': ["Ты попал. Честно. Без подлянок.", "Уверенный результат. Можно идти дальше.", "Враг почувствовал. И ему стало обидно.", "Хороший замах. Достойное попадание."],
        'dex': ["Ты увернулся. Не изящно, но эффективно.", "Реакция сработала. Без блеска, но с результатом.", "Ты ушел от удара. Жить можно.", "Ловкость сегодня не подвела."],
        'str': ["Ты выдержал. Через зубы, но устоял.", "Силы хватило. Впритык, но хватило.", "Мышцы справились. Им можно налить.", "Ты устоял на ногах."],
        'cha': ["Ты говоришь уверенно. Тебя слушают.", "Ты понравился. Не влюбил, но понравился.", "Комплимент зашёл. Контакт есть.", "Ты убедителен. Без магии, но со смыслом."],
        'summon': ["Ты позвал — и оно пришло. Без энтузиазма, но пришло.", "Призыв сработал. Существо явилось.", "Ты призвал помощь. Она здесь.", "Призыв удался. Но существо просит добавить."],
        'gamble': ["Тебе везёт. Потиньку. Без фанатизма.", "Удача рядом. Дышит в спину. Помогает.", "Монетка упала орлом. Не решкой. Уже неплохо.", "Ты сегодня в плюсе."],
        'default': ["Сегодня неплохой денёк. Для везения.", "Удача не отвернулась.", "Фарт есть. Немного. На донышке.", "Тебе чуть-чуть повезло."]
    },
    'low': {
        'mind': ["Мысль была. Убежала. Догонять лень.", "Ты вспомнил, что ничего не помнишь.", "В голове шум. Без мыслей.", "Ты попытался думать. Не получилось."],
        'magic': ["Магия фыркнула. Обиделась.", "Вышло слабо. Даже свечка бы ярче горела.", "Ты хотел как лучше. Получилось никак.", "Заклинание вышло кривым."],
        'attack': ["Ты махнул. Воздух даже не шелохнулся.", "Удар был. Слабый. Жалкий.", "Ты старался. Правда. Не получилось.", "Противник даже не заметил атаки."],
        'dex': ["Ты дернулся. Не туда. Не тогда.", "Увернуться? Не вариант. Упасть? Пожалуйста.", "Твоя ловкость ушла в минус.", "Ты споткнулся."],
        'str': ["Ты попытался. Честно. Просто не смог.", "Силы кончились. Ещё до того, как начались.", "Ты сложился. Как стульчик.", "Мышцы сдали. Предали."],
        'cha': ["Ты что-то сказал. Все сделали вид, что глухие.", "Неловкость повисла. Густая.", "Ты улыбнулся. Все напряглись.", "Разговор не задался."],
        'summon': ["Ты позвал. Тишина. Обидная.", "Призыв не удался. Существо занято.", "Ты призвал что-то. Оно чихнуло и ушло.", "Призыв сработал в полсилы."],
        'gamble': ["Тебе не везёт. Даже по мелочи.", "Удача ушла. За ней закрылась дверь.", "Монетка упала. В унитаз.", "Ты проиграл. Ещё до начала игры."],
        'default': ["Сегодня не твой день. Вообще никак.", "Удача помахала ручкой и ушла.", "Фарт закончился. Ещё вчера.", "Тебе не повезло. В который раз."]
    }
}

def get_roll_data(text):
    text = text.strip().lower()
    match = re.match(r'^(\d*)d(\d+)\s*([+-]\s*\d+)?\s*(.*)$', text)
    if not match: return None
    
    count = int(match.group(1)) if match.group(1) else 1
    sides = int(match.group(2))
    mod = int(match.group(3).replace(" ", "")) if match.group(3) else 0
    description = match.group(4).strip()
    
    return {
        "count": count, "sides": sides, "mod": mod, 
        "formula": f"{count if count > 1 else ''}d{sides}{f'{mod:+}' if mod != 0 else ''}", 
        "text": description
    }

def get_phrase(roll_val, desc):
    category = 'default'
    if desc:
        for cat, kws in KEYWORDS.items():
            if any(kw in desc for kw in kws):
                category = cat
                break
    
    res_type = None
    if roll_val == 20: res_type = 'crit_success'
    elif roll_val == 1: res_type = 'crit_fail'
    elif 15 <= roll_val <= 19: res_type = 'high'
    elif 2 <= roll_val <= 14: res_type = 'low'
    
    if not res_type: return None
    type_data = PHRASES.get(res_type, {})
    return random.choice(type_data.get(category, type_data.get('default', ["..."])))

@router.inline_query()
async def inline_handler(query: types.InlineQuery):
    input_text = query.query.strip().lower() or "d20"
    data = get_roll_data(input_text)
    if not data: return await query.answer([], cache_time=0)

    rolls = [random.randint(1, data['sides']) for _ in range(data['count'])]
    raw_roll, total = rolls[0], sum(rolls) + data['mod']
    
    res_text = f"({data['formula']}) {total} [{', '.join(map(str, rolls)) if data['count'] > 1 else raw_roll}]"
    if data['text']: res_text += f" {data['text']}"
    
    if data['count'] == 1 and data['sides'] == 20:
        phrase = get_phrase(raw_roll, data['text'])
        if phrase: res_text += f"\n\n{phrase}"

    results = [types.InlineQueryResultArticle(
        id=os.urandom(16).hex(),
        title=f"Результат: {total}",
        description=f"Бросок {data['formula']} {data['text']}",
        input_message_content=types.InputTextMessageContent(message_text=res_text)
    )]
    
    if data['count'] > 1 and data['mod'] != 0:
        mod_rolls = [r + data['mod'] for r in rolls]
        res_each = f"({data['formula']} к каждому) {sum(mod_rolls)} [{', '.join(map(str, mod_rolls))}] {data['text']}"
        results.append(types.InlineQueryResultArticle(
            id=os.urandom(16).hex(),
            title="К каждому кубику",
            description=f"Применить {data['mod']:+2} к каждому кубу",
            input_message_content=types.InputTextMessageContent(message_text=res_each)
        ))

    await query.answer(results, cache_time=0, is_personal=True)

async def handle(request): return web.Response(text="Bot is running")

async def main():
    dp = Dispatcher()
    dp.include_router(router)
    app = web.Application()
    app.router.add_get('/', handle)
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', int(os.getenv("PORT", 10000)))
    await asyncio.gather(dp.start_polling(bot, skip_updates=True), site.start())

if __name__ == '__main__':
    asyncio.run(main())
