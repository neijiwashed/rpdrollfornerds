import logging, re, random, asyncio, os
from aiogram import Bot, Dispatcher, types, Router
from aiohttp import web

API_TOKEN = os.getenv('BOT_TOKEN')

logging.basicConfig(level=logging.ERROR)
bot = Bot(token=API_TOKEN)
router = Router()

KEYWORDS = {
    'mind': ['ум', 'интеллект', 'внимательность', 'знания', 'мудрость', 'расследование', 'вспомнить', 'понять', 'догадаться', 'запомнить'],
    'magic': ['магия', 'магический', 'заклинание', 'колдовать', 'аркана', 'чары', 'волшебство', 'энергия', 'потоки'],
    'attack': ['атака', 'удар', 'выпад', 'серия'],
    'dex': ['ловкость', 'реакция', 'уклонение', 'акробатика', 'грация', 'спрыгнуть', 'увернуться', 'спас ловкости'],
    'str': ['сила', 'мощь', 'атлетика', 'живучесть', 'выдержать', 'устоять', 'спас силы'],
    'cha': ['харизма', 'обаяние', 'убеждение', 'запугивание', 'обман', 'блеф', 'выступление', 'флирт'],
    'summon': ['призыв', 'призвать', 'вызвать', 'summon'],
    'gamble': ['везение', 'казино', 'ставка', 'монетка', 'фортуна', 'азарт']
}

PHRASES = {
    'crit_success': {
        'mind': ["Двадцатка на ум. Мастер, втирай ему по полной", "Твой мозг только что кончил. Мастер, не подведи", "Ай гений! Ай мудрец! Ай фонтан мыслей!", "Ты вспомнил даже то чего не знал. Боги что-ли подсказали", "Ну ты Шерлок! Ну ты Декарт!", "Гениально. Мастер, готовь описание, сейчас будет момент истории", "Аристотель нервно курит в сторонке.", "Ай голова! Ай светоч разума! Ай кладезь мудрости!", "Решение пришло само, с небес. Мастер, не спорь, боги одобрили"],
        'magic': ["Двадцатка на магию. Колдун ебучий", "Твое заклинание вышло таким мощным, что у магии случился оргазм", "Ай маг! Ай волшебник! Ай повелитель стихий!", "Ты колданул так, что боги в штаны наложили.", "Огонь, вода и медные трубы — всё тебе подвластно!", "Ай чародей! Ай кудесник! Ай повелитель потустороннего!", "Ты не просто сотворил магию, ты её поимел.", "Мерлин отдыхает. Гендальф в ауте. Дамблдор сосет.", "Ты сиял так ярко, что солнце попросило автограф"],
        'attack': ["ДВАДЦАТКА НА АТАКУ. ВТИРАЙ ЕМУ ПО САМЫЕ НИХУЯ СЕБЕ", "Твой удар был таким жестким, что враг обосрался еще до попадания", "Ай воин! Ай берсерк! Ай машина смерти!", "Ты вложил в это всю душу и немного яиц.", "Ай лев!", "Ай тигр!", "Ай кашалот!", "Ты попал так, что противник щас родит", "Ай крушитель! Ай сокрушитель!", "Твоя атака вошла бы в историю", "Ну ты терминатор! Ну ты машина! Ну ты мясорубка!"],
        'dex': ["Ты увернулся так, что смерть пролетела мимо и врезалась в стену.", "Ай акробат! Ай гуттаперчевый!", "Твое тело сделало то, что порноактеры даже не пробовали.", "Ай неуловимый! Ай просто призрак!", "Твоя реакция быстрее, чем член таксиста при виде школьницы.", "Брюс Ли в гробу перевернулся.", "Твой кульбит заставил богов аплодировать стоя."],
        'str': ["Двадцатка на силу. Пусть вывозит на голых яйцах", "Ты выдержал это без соплей и без смазки.", "Ай богатырь!", "Ай медведь шатун!", "Ай Геркулес! Ай Самсон!", "Ты устоял там, где падали титаны.", "Твой организм крепче, чем брак в деревне."],
        'cha': ["Двадцатка на харизму. Мастер, пусть уболтает кого угодно", "Ты открыл рот. Мастер, у всех потекли слюни, в штанах", "Ай оратор! Ай сердцеед! Ай дьявол искуситель!", "Твои слова заставили богов кончить. Мастер, громко, на всю вселенную", "Ай красавчик! Ай обаяшка! Ай разбиватель сердец!", "Ты соврал так красиво. Мастер, ложь забеременела и родила правду", "Ай лидер! Ай вожак! Ай за кем хочешь пойдешь!", "Твоя улыбка растопила трусики на собеседнице. Морально, Мастер, но факт", "Ну ты Казанова! Ну ты Дон Жуан! Ну ты просто секс-бомба!", "Ты заговорил. Мастер, даже демоны захотели в рай, с тобой"],
        'summon': ["Двадцатка на призыв. Мастер, пусть придет то самое", "Ты позвал. Мастер, пришло ТО САМОЕ, оно довольно, ты тоже", "Ай заклинатель! Ай повелитель духов! Ай хозяин бездны!", "Твой призыв был настолько мощным. Мастер, явились даже те, кого не звали", "Ай призыватель! Ай открыватель порталов! Ай друг потусторонних!", "Существо пришло и сразу встало раком. \"Командуй\", говорит. Мастер, красота", "Ай повелитель! Ай господин! Ай кому хочешь прикажешь!", "Ты крикнул в бездну. Мастер, бездна ответила: \"Чего изволите, господин?\"", "Ну ты маг! Ну ты властелин! Ну ты всех вызвал и всех построил!", "Существо явилось и сразу предложило минет. Мастер, в знак уважения, не отказывайся"],
        'gamble': ["Двадцатка на везение. Мастер, пусть казино плачет", "Фортуна сегодня не просто с тобой. Мастер, она у тебя в кармане и делает минет", "Ай везунчик! Ай счастливчик! Ай любимец фортуны!", "Ты может сейчас поставить на зеро всё. Мастер, и выиграть казино целиком", "Ай баловень судьбы! Ай избранник удачи! Ай козырной туз!", "Удача прет так, что аж жопа горит. Счастьем, Мастер, счастьем", "Ай фартовый! Ай удалой! Ай кому всегда везет!", "Монетка падает орлом. Мастер, даже если у орла решка, просто потому что ты так хочешь", "Ну ты счастливчик! Ну ты удачливый! Ну ты просто джекпот!", "Тебе сегодня нельзя проиграть. Мастер, даже если очень стараться"],
        'default': ["Двадцатка просто так. Мастер, просто повезло, просто пиздато", "Тебе сегодня пиздато. Мастер, просто по жизни, прям сейчас", "Ай красава! Ай молодец! Ай просто хорош!", "Удача выбрала тебя. Мастер, и теперь вы вместе, навсегда", "Ай счастливый! Ай удалой! Ай просто красавчик!", "Ты просто идешь и всё получается. Мастер, без напряга, без понтов", "Ай везет! Ай прет! Ай просто фарт со всех щелей!", "Сегодня твой день. Мастер, месяц, год, жизнь, радуйся", "Ну ты молоток! Ну ты огонь! Ну ты просто пожар!", "Везет так, что аж страшно. Мастер, но приятно, как в первый раз"]
    },
    'crit_fail': {
        'mind': ["Единица на ум. Мастер, ЕБИ ЕГО, пусть просрется", "Твой мозг только что ушел в астрал. Мастер, без обратного билета, свалил нахуй", "Ебать ты лох. Ебать ты тормоз. Ебать ты дерево.", "Ты вспомнил как звали хомяка в 5 лет. Мастер, а надо было вспомнить как дышать", "Ай дурак! Ай олух! Ай просто пень с глазами!", "В голове пустота. Мастер, такая густая, что можно ложкой есть", "Ой вей. Ой вей. Ой вей, шо ты натворил.", "Ты так глубоко задумался. Мастер, что забыл выдохнуть, посинел немного", "Ай растяпа! Ай раззява! Ай просто голова садовая!", "Твоя мысль убежала так далеко. Мастер, что ей уже не вернуться, прощай"],
        'magic': ["Единица на магию. Мастер, ВТИРАЙ ЕМУ, пусть пшикнет", "Ты хотел файрбол. Мастер, получился пшик, обидный, вонючий", "Ну ты маг-недоучка. Ну ты волшебник-самоучка. Ну ты просто пшикатель.", "Твое заклинание вышло кривым настолько. Мастер, что его удалили из книг", "Ай недомаг! Ай недоделок! Ай просто пшик с приветом!", "Магия посмотрела на тебя. Мастер, и сказала: \"С таким лицом только в церковь\"", "Ой дурак. Ой дурак. Ой ну просто дурак.", "Ты попытался колдовать. Мастер, вселенная засмеялась, громко, на всю катушку", "Ай шарлатан! Ай фокусник херов! Ай просто пузырь с магией!", "Ты перепутал ингредиенты. Мастер, теперь ты пахнешь как бордель после пожара"],
        'attack': ["ЕДИНИЦА НА АТАКУ. МАСТЕР, ПОРОТЬ ЕГО, ПОРОТЬ ДО КРОВИ", "Ты махнул. Мастер, воздух даже не заметил, ему похуй", "Ебать ты воин. Ебать ты боец. Ебать ты просто тряпка.", "Твой удар увидели потомки. Мастер, они ржут до сих пор, сквозь века", "Ай неудачник! Ай горе-боец! Ай просто мешок с костями!", "Ты промахнулся так эпично. Мастер, что попал в себя, морально, но больно", "Ой слабак. Ой дохляк. Ой просто тряпка.", "Противник даже не понял, что это атака. Мастер, думал ты привет машешь", "Ай вояка! Ай боец хренов! Ай просто позор нации!", "Ты старался честно. Мастер, но удара не вышло, как член у импотента"],
        'dex': ["Единица на ловкость. Мастер, пусть упадет лицом в грязь", "Ты споткнулся о собственную ногу. Мастер, потом о вторую, потом упал в грязь лицом", "Ебать ты акробат. Ебать ты гимнаст. Ебать ты просто бревно.", "Твоя реакция ушла в запой. Мастер, без тебя, с твоими деньгами, всё пропил", "Ай неуклюжий! Ай неловкий! Ай просто слон в посудной лавке!", "Ты попытался увернуться. Мастер, получилось как у пьяного жирафа на льду", "Ой тюлень. Ой корова на льду. Ой просто пень.", "Гравитация сегодня выбрала тебя своей игрушкой. Мастер, она играет, ты падаешь", "Ай увалень! Ай недотыка! Ай просто чурбан с ногами!", "Ты упал сам без помощи на ровном месте. Мастер, рекорд, гордиться нечем"],
        'str': ["Единица на силу. Мастер, пусть сложится как картонный домик", "Твои мышцы написали заявление. Мастер, \"уходим, нахуй всё, мы не работаем\"", "Ебать ты силач. Ебать ты качок. Ебать ты просто дистрофик.", "Ты попытался быть сильным. Мастер, получилось жалким, очень, даже бабки смеются", "Ай слабак! Ай доходяга! Ай просто тряпка мышечная!", "Силы покинули тебя. Мастер, как крысы тонущий корабль, с чемоданами", "Ой хиляк. Ой задохлик. Ой просто ветром сдует.", "Ты сложился как карточный домик в ураган. Мастер, красиво, картинно", "Ай немощный! Ай бессильный! Ай просто студень на костях!", "Ты выдержал ровно ноль секунд. Мастер, это новый антирекорд"],
        'cha': ["Единица на харизму. Мастер, пусть все отвернутся и плюнут", "Ты открыл рот. Мастер, и все захотели его закрыть, навсегда, кирпичом", "Ебать ты Казанова. Ебать ты сердцеед. Ебать ты просто кринж.", "Ты попытался пошутить. Мастер, тишина была такой громкой, что лопнули перепонки", "Ай урод! Ай страшила! Ай просто пугало огородное!", "Твоя улыбка испугала даже демонов. Мастер, они вызвали экзорциста", "Ой неловкость. Ой стыдоба. Ой просто позорище.", "Ты соврал. Мастер, даже камень покраснел, от стыда за тебя", "Ай заика! Ай мямля! Ай просто рыба безголосая!", "Ты хотел быть милым. Мастер, получилось криповым, очень, дети плачут"],
        'summon': ["Единица на призыв. Мастер, пусть придет то, от чего волосы дыбом", "Ты позвал. Мастер, никто не пришел, даже тень от тебя ушла", "Ебать ты заклинатель. Ебать ты повелитель. Ебать ты просто пустозвон.", "Ты призвал существо. Мастер, оно посмотрело, засмеялось и ушло обратно", "Ай горе-призыватель! Ай открыватель порталов в никуда!", "Призыв удался. Мастер, пришло ТО, оно зло, оно хочет жрать, и ты главное блюдо", "Ой обосрался. Ой просрал. Ой просто пиздец.", "Ты крикнул в пустоту. Мастер, пустота крикнула в ответ: \"Пошел нахуй\"", "Ай неудачник! Ай непризвавший! Ай просто голос в пустоте!", "Ты позвал помощь. Мастер, помощь занята, у нее свои проблемы"],
        'gamble': ["Единица на везение. Мастер, пусть проиграет всё, даже душу", "Тебе нельзя играть даже в \"очко\". Мастер, проиграешь штаны, и душу, и почку", "Ебать ты везунчик. Ебать ты счастливчик. Ебать ты просто магнит для говна.", "Удача плюнула тебе в лицо. Мастер, и ушла к другому, навсегда", "Ай невезучий! Ай злополучный! Ай просто ходячее горе!", "Ты мог бы проиграть даже в игре где один игрок — ты. Мастер, и проиграл", "Ой неудачник. Ой горемыка. Ой просто лузер.", "Монетка упала в унитаз. Мастер, смылась, в никуда, как твои надежды", "Ай не фартит! Ай не прет! Ай просто черная полоса!", "Тебе не везет даже в лотерее где все выигрывают. Мастер, ты исключение"],
        'default': ["Единица просто так. Мастер, просто не повезло, просто просрал", "Тебе не повезло совсем. Мастер, даже квантово, даже теоретически", "Ебать ты лох. Ебать ты неудачник. Ебать ты просто лузер.", "Удача помахала ручкой. Мастер, села в поезд, уехала, навсегда", "Ай горемыка! Ай злосчастный! Ай просто неудачник по жизни!", "Ты просто неудачник по жизни. Мастер, сегодня генетика подтвердила", "Ой блин. Ой облом. Ой просто пичалька.", "Фарт кончился еще в роддоме.", "Ай не повезло! Ай не задалось! Ай просто день не твой!", "Сегодня не твой день."]
    }
}

def get_roll_data(text):
    text = text.strip().lower()
    match = re.match(r'^(\d*)d(\d+)\s*([+-]\s*\d+)?\s*(.*)$', text)
    if not match: return None
    
    count = int(match.group(1)) if match.group(1) else 1
    sides = int(match.group(2))
    mod = int(match.group(3).replace(" ", "")) if match.group(3) else 0
    description = match.group(4).strip()
    
    return {
        "count": count, "sides": sides, "mod": mod, 
        "formula": f"{count if count > 1 else ''}d{sides}{f'{mod:+}' if mod != 0 else ''}", 
        "text": description
    }

def get_phrase(raw_roll, desc):
    if raw_roll == 20: res_type = 'crit_success'
    elif raw_roll == 1: res_type = 'crit_fail'
    else: return None

    category = 'default'
    if desc:
        for cat, kws in KEYWORDS.items():
            if any(kw in desc.lower() for kw in kws):
                category = cat
                break
    
    type_data = PHRASES.get(res_type, {})
    options = type_data.get(category, type_data.get('default', ["..."]))
    return random.choice(options)

@router.inline_query()
async def inline_handler(query: types.InlineQuery):
    input_text = query.query.strip().lower()
    
    options_to_process = [input_text] if input_text else ["d20", "d100"]

    results = []
    for opt in options_to_process:
        data = get_roll_data(opt)
        if not data: continue

        rolls = [random.randint(1, data['sides']) for _ in range(data['count'])]
        raw_roll = rolls[0]
        total = sum(rolls) + data['mod']
        
        res_text = f"({data['formula']}) {total} [{', '.join(map(str, rolls)) if data['count'] > 1 else raw_roll}]"
        if data['text']: res_text += f" {data['text']}"
        
        if data['count'] == 1 and data['sides'] == 20:
            phrase = get_phrase(raw_roll, data['text'])
            if phrase: res_text += f"\n\n{phrase}"

        results.append(types.InlineQueryResultArticle(
            id=os.urandom(16).hex(),
            title=f"Бросить {data['formula']}",
            description="Нажмите, чтобы бросить кубик",
            input_message_content=types.InputTextMessageContent(message_text=res_text)
        ))

        if data['count'] > 1 and data['mod'] != 0:
            mod_rolls = [r + data['mod'] for r in rolls]
            res_each = f"({data['formula']} к каждому) {sum(mod_rolls)} [{', '.join(map(str, mod_rolls))}]"
            if data['text']: res_each += f" {data['text']}"
            
            results.append(types.InlineQueryResultArticle(
                id=os.urandom(16).hex(),
                title=f"Применить {data['mod']:+2} к каждому",
                description="Нажмите, чтобы бросить кубик",
                input_message_content=types.InputTextMessageContent(message_text=res_each)
            ))

    await query.answer(results, cache_time=0, is_personal=True)

async def handle(request): return web.Response(text="Bot is running")

async def main():
    dp = Dispatcher()
    dp.include_router(router)
    app = web.Application()
    app.router.add_get('/', handle)
    runner = web.AppRunner(app)
    await runner.setup()
    site = web.TCPSite(runner, '0.0.0.0', int(os.getenv("PORT", 10000)))
    await asyncio.gather(dp.start_polling(bot, skip_updates=True), site.start())

if __name__ == '__main__':
    asyncio.run(main())

